<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Who the Fact Are You? ‚Äî Bingo</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
      crossorigin="anonymous" referrerpolicy="no-referrer" />
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>

<style>
  :root{
    --ui-font-size: 16px;
    --brand-red: #e53935;
    --bg: #ffffff;
    --text: #111111;
    --muted: #6b7280;
    --tile: #fafafa;
    --tile-border: #ececec;
    --accent: #ef4444;
    --bingo-green: #22c55e;
  }
  body.dark{
    --bg:#0b0e16; --text:#ffffff; --muted:#9ca3af; --tile:#0b1220; --tile-border:#16202a; --accent:#f87171;
  }
  *{ box-sizing: border-box; }
  html { font-size: var(--ui-font-size); }
  body{ margin:0; font-family: "Poppins", system-ui, -apple-system, "Segoe UI", Roboto, Arial; background:var(--bg); color:var(--text); -webkit-text-size-adjust:100%; }

  .app-wrapper{ min-height:100dvh; border:10px solid var(--brand-red); display:flex; flex-direction:column; }

  header{
    padding: calc(0.75rem + 6px) 1rem;
    display:flex; gap:0.75rem; align-items:center;
  }
  .logo{ width:3.2rem; height:3.2rem; object-fit:contain; border-radius:0.5rem; background:#fff; flex:0 0 auto; margin-right:0.5rem; z-index:2; }
  .brand{ display:flex; flex-direction:column; align-items:flex-start; flex:1 1 auto; min-width:0; }
  .brand .subtitle{ font-size:0.75rem; color:var(--muted); text-transform:uppercase; margin:0 0 0.125rem 0; }
  .brand .title{ font-weight:800; font-size:clamp(18px, 4.5vw, 28px); margin:0; line-height:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; padding-left:0; }

  .controls{ padding:0.5rem 1rem; display:flex; gap:0.5rem; flex-wrap:wrap; align-items:center; }
  .btn{ padding:0.5rem 0.75rem; border-radius:999px; border:1px solid var(--tile-border); background:var(--tile); color:var(--text); cursor:pointer; font-size:1rem; }
  .btn.primary{ background:var(--accent); color:#fff; border:none; }
  .hint{ font-size:0.8125rem; color:var(--muted); }
  .font-controls{ display:inline-flex; gap:0.5rem; align-items:center; }

  .board-container{ padding:0.5rem 1rem 1rem; flex:1; }
  .board{ display:grid; gap:0.75rem; align-items:stretch; }

  .tile{
    background:var(--tile); border:1px solid var(--tile-border); border-radius:0.875rem;
    display:flex; flex-direction:column; position:relative; padding:0.75rem 0.75rem 3.0rem 0.75rem; overflow:hidden;
    min-height:6.5rem; color:var(--text); text-align:left;
    transition: box-shadow .12s ease, transform .08s ease, background .12s ease, outline-color .12s ease;
  }
  .tile:active { transform: translateY(1px); }

  .fact{ font-size: 0.95rem; line-height:1.25; font-weight:600; margin-bottom:0.5rem; color:var(--text); word-break:break-word; }
  .meta{ margin-top:auto; font-size: 0.825rem; color:var(--muted); display:flex; gap:0.5rem; align-items:center; }
  .entry{ margin-top:0.5rem; font-size: 0.875rem; color:var(--text); }
  .who{ font-weight:700; word-break:break-word; white-space:normal; max-width:100%; font-size:0.95rem; }
  .resp{ margin-top:0.25rem; opacity:0.95; font-size:0.875rem; }

  .fa-icon{ position:absolute; right:0.625rem; bottom:0.625rem; opacity:.22; font-size:1.6rem; display:none; pointer-events:none; }
  .emoji-fallback{ position:absolute; right:0.625rem; bottom:0.625rem; opacity:.22; font-size:1.6rem; display:inline-block; pointer-events:none; }

  .tile.filled {
    outline: 3px solid var(--bingo-green);
    box-shadow: 0 8px 26px rgba(34,197,94,0.07);
    background: linear-gradient(180deg, rgba(34,197,94,0.06), var(--tile));
  }
  .tile.filled .meta::before{
    content: '';
    width: 10px; height: 10px; background: var(--bingo-green); border-radius: 50%; display:inline-block; margin-right:6px; box-shadow:0 1px 0 rgba(0,0,0,0.06);
  }
  .tile.filled .emoji-fallback { opacity: 1; }

  dialog.modal{ border:none; border-radius:0.75rem; padding:0; width:min(40rem,94vw); background:var(--tile); color:var(--text); }
  dialog.modal::backdrop{ background: rgba(0,0,0,0.35); }
  .modal .inner{ padding:0.875rem; }
  .modal .hint{ color:var(--text); font-weight:800; margin-bottom:0.5rem; }
  .modal input, .modal textarea{ width:100%; padding:0.5rem 0.75rem; border-radius:0.625rem; border:1px solid var(--tile-border); background:var(--bg); color:var(--text); font-size:16px; }
  .modal .actions{ display:flex; justify-content:flex-end; gap:0.5rem; margin-top:0.5rem; }
  .modal .btn{ color:var(--text); background:transparent; border:1px solid var(--tile-border); padding:0.5rem 0.75rem; border-radius:0.5rem; }
  .modal .btn.primary{ background:var(--accent); color:#fff; border:none; }

  .bingo-overlay{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.35); z-index:9999; }
  .bingo-overlay.show{ display:flex; }
  .bingo-text{ font-weight:900; font-size:4rem; color:#fff; text-shadow:0 6px 22px rgba(0,0,0,.55); }

  footer{ padding:0.5rem 1rem; display:flex; justify-content:space-between; align-items:center; font-size:0.8125rem; color:var(--muted); }

  @media (max-width:760px){
    header{ padding:0.5rem 0.75rem; gap:0.5rem; }
    .logo{ width:2.4rem; height:2.4rem; flex:0 0 auto; margin-right:0.5rem; }
    .brand{ align-items:flex-start; }
    .brand .title { font-size: clamp(16px, 6vw, 20px); white-space:normal; line-height:1.02; }
    .tile{ padding:0.625rem 0.625rem 2.5rem 0.625rem; min-height:5.75rem; }
    .bingo-text{ font-size:3rem; }
    .modal input, .modal textarea{ font-size:16px; }
  }
</style>
</head>
<body>
  <div class="app-wrapper" id="app">
    <header>
      <img class="logo" src="https://tse2.mm.bing.net/th/id/OIP.vB2_MMCK6wxXLJRR_2APTgAAAA?r=0&rs=1&pid=ImgDetMain&o=7&rm=3" alt="Engage Squared logo"
           onerror="this.src='https://via.placeholder.com/120x40?text=Engage+Squared'"/>
      <div class="brand">
        <div class="subtitle" id="subtitle">ENGAGE SQUARED</div>
        <h1 class="title" id="pageTitle">Who the Fact Are You? üéâ</h1>
      </div>
      <div style="width:3.5rem; flex:0 0 auto;"></div>
    </header>

    <div class="controls" role="region" aria-label="controls">
      <div style="display:flex;gap:0.5rem;align-items:center;flex-wrap:wrap;">
        <select id="langSel" aria-label="Language" class="btn">
          <option value="en">English</option>
          <option value="ja">Êó•Êú¨Ë™û</option>
          <option value="id">Bahasa Indonesia</option>
        </select>
        <button id="darkToggle" class="btn" aria-pressed="false">üåô Dark mode</button>
      </div>

      <div style="display:flex; gap:0.5rem; align-items:center; flex-wrap:wrap; margin-left:8px;">
        <!-- layout selector -->
        <label for="layoutSel" class="hint" style="display:inline-flex; align-items:center; gap:0.375rem;">
          <select id="layoutSel" class="btn" aria-label="Board layout">
            <option value="4x4">4√ó4</option>
            <option value="3x3">3√ó3</option>
            <option value="3x4">3√ó4</option>
          </select>
        </label>

        <button id="randomBtn" class="btn">üîÄ <span data-i18n="randomize">Randomise board</span> (<span id="rndLeft">3</span>)</button>
        <button id="startBtn" class="btn primary">‚ñ∂ <span data-i18n="start">Start Bingo</span></button>

        <div class="font-controls" style="margin-left:0.5rem;">
          <button id="fontDec" class="btn" title="Decrease font">A‚àí</button>
          <button id="fontInc" class="btn" title="Increase font">A+</button>
        </div>

        <div id="preHint" class="hint" style="margin-left:0.5rem;">You can shuffle up to 3√ó before starting.</div>
      </div>

      <div style="margin-left:auto;" class="hint" id="howto">Tap a tile to enter a name + a short response. Fill lines to get BINGO!</div>
    </div>

    <div class="board-container">
      <main id="board" class="board" aria-live="polite"></main>
    </div>

    <footer>
      <div id="progress">0/16 filled ¬∑ 0 bingo lines</div>
      <div>Made with ‚ù§Ô∏è by your friendly neighbourhood Liam</div>
    </footer>
  </div>

  <dialog class="modal" id="entryModal">
    <form method="dialog" class="inner" onsubmit="return false;">
      <h3 id="modalTitle">Add a name & response</h3>
      <div id="modalFact" class="hint" style="margin-bottom:8px;"></div>

      <label id="nameLabel" for="nameInput">Name</label>
      <input id="nameInput" type="text" placeholder="Type their name" required style="margin-bottom:8px; font-size:16px;" maxlength="40" />

      <label id="respLabel" for="respInput">Response</label>
      <textarea id="respInput" placeholder="A few words‚Ä¶" required style="font-size:16px;" rows="3"></textarea>
      <div style="display:flex; justify-content:space-between; align-items:center; margin-top:6px;">
        <div class="hint" id="respHint">Max <span id="charLimit">60</span> chars</div>
        <div class="hint" id="charCount">60 left</div>
      </div>

      <div class="actions" style="margin-top:8px;">
        <button id="cancelBtn" class="btn" value="cancel">Cancel</button>
        <button id="saveBtn" class="btn primary" value="confirm">Save</button>
      </div>
    </form>
  </dialog>

  <div class="bingo-overlay" id="bingoOverlay"><div class="bingo-text" id="bingoText">BINGO!</div></div>

  <audio id="clapAudio" preload="auto" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_b4a41e8d27.mp3?filename=small-crowd-clapping-6695.mp3"></audio>

<script>
/* Config */
const RESPONSE_CHAR_LIMIT = 60; // per-response character cap

/* i18n ‚Äî only English expanded here for brevity; include other languages if desired */
const I18N = {
  en: {
    ui: {
      language: 'Language:', dark: 'Dark mode', light: 'Light mode', randomize: 'Randomise board',
      start: 'Start Bingo', reset: 'Reset Board', prehint: 'You can shuffle up to 3√ó before starting.',
      howto: 'Tap a tile then add a name & short response. Fill lines to get BINGO!',
      add: 'Add a name & response', name: 'Name', response: 'Response', cancel: 'Cancel', save: 'Save',
      filled: (n, total) => `${n}/${total} filled`, lines: (n) => `${n} bingo line${n === 1 ? '' : 's'}`
    },
    facts: [
      '‚Ä¶has worked at the company for over 10 years',
      '‚Ä¶has a hidden talent they‚Äôve performed publicly',
      '‚Ä¶has travelled to more than 5 countries',
      '‚Ä¶speaks more than two languages',
      '‚Ä¶has met someone famous',
      '‚Ä¶has run a marathon or completed a major fitness challenge',
      '‚Ä¶has a pet that‚Äôs not a dog or cat',
      '‚Ä¶has lived in more than three cities',
      '‚Ä¶has the same birth month as you',
      '‚Ä¶has worked in a completely different industry before',
      '‚Ä¶has a side hustle or passion project',
      '‚Ä¶has been with the company less than 6 months',
      '‚Ä¶has a unique hobby (e.g., beekeeping, pottery, fencing)',
      '‚Ä¶has never had coffee',
      '‚Ä¶has been on TV or radio',
      '‚Ä¶has a twin or is a twin',
      '‚Ä¶has gone skydiving or bungee jumping',
      '‚Ä¶has a tattoo with a story behind it',
      '‚Ä¶has attended a concert in the last month',
      '‚Ä¶has read more than 20 books this year',
      '‚Ä¶has worked remotely from another country',
      '‚Ä¶has a collection of something unusual',
      '‚Ä¶has been part of a theatre production',
      '‚Ä¶has a nickname they still go by',
      '‚Ä¶has won a competition or award',
      '‚Ä¶has a favourite podcast they recommend',
      '‚Ä¶has a bucket list item they‚Äôve completed',
      '‚Ä¶has a go-to karaoke song',
      '‚Ä¶can do a celebrity impression on the spot',
      '‚Ä¶has a weird food combo they love (and will defend)',
      '‚Ä¶has a pet with a human name',
      '‚Ä¶has tried an extreme sport (and survived)',
      '‚Ä¶has been mistaken for someone famous',
      '‚Ä¶has a viral TikTok or Reel (or knows someone who does)',
      '‚Ä¶has a favourite emoji they overuse',
      '‚Ä¶has a favourite conspiracy theory (for fun!)',
      '‚Ä¶has a favourite fictional character they relate to',
      '‚Ä¶has a story about a travel fail',
      '‚Ä¶has a favourite board game or card game',
      '‚Ä¶has a food they refuse to eat under any circumstance'
    ]
  }
};

/* Icons */
const ICONS = [
  { fa:'fa-briefcase', emoji:'üè¢' }, { fa:'fa-masks-theater', emoji:'üé§' }, { fa:'fa-earth-americas', emoji:'üåç' },
  { fa:'fa-language', emoji:'üó£Ô∏è' }, { fa:'fa-star', emoji:'‚≠ê' }, { fa:'fa-person-running', emoji:'üèÉ' },
  { fa:'fa-paw', emoji:'ü¶é' }, { fa:'fa-city', emoji:'üèôÔ∏è' }, { fa:'fa-cake-candles', emoji:'üéÇ' },
  { fa:'fa-rotate', emoji:'üîÑ' }, { fa:'fa-lightbulb', emoji:'üí°' }, { fa:'fa-seedling', emoji:'üÜï' },
  { fa:'fa-palette', emoji:'üé®' }, { fa:'fa-mug-saucer', emoji:'üö´‚òï' }, { fa:'fa-tv', emoji:'üì∫' },
  { fa:'fa-people-arrows', emoji:'üëØ' }, { fa:'fa-parachute-box', emoji:'ü™Ç' }, { fa:'fa-pen-nib', emoji:'üñãÔ∏è' },
  { fa:'fa-music', emoji:'üé∂' }, { fa:'fa-book-open', emoji:'üìö' }, { fa:'fa-laptop-house', emoji:'üíª' },
  { fa:'fa-box-archive', emoji:'üì¶' }, { fa:'fa-masks-theater', emoji:'üé≠' }, { fa:'fa-id-badge', emoji:'üè∑Ô∏è' },
  { fa:'fa-trophy', emoji:'üèÜ' }, { fa:'fa-podcast', emoji:'üéß' }, { fa:'fa-list-check', emoji:'‚úÖ' },
  { fa:'fa-microphone', emoji:'üé§' }, { fa:'fa-face-grin-stars', emoji:'üòé' }, { fa:'fa-burger', emoji:'üçï' },
  { fa:'fa-dog', emoji:'üê∂' }, { fa:'fa-person-skiing', emoji:'üèÑ' }, { fa:'fa-user-check', emoji:'üëÄ' },
  { fa:'fa-mobile-screen', emoji:'üì±' }, { fa:'fa-face-grin', emoji:'üòä' }, { fa:'fa-user-secret', emoji:'üõ∏' },
  { fa:'fa-hat-wizard', emoji:'ü¶∏' }, { fa:'fa-suitcase-rolling', emoji:'üß≥' }, { fa:'fa-chess-board', emoji:'üé≤' },
  { fa:'fa-ban', emoji:'üö´üçΩÔ∏è' }
];

/* DOM refs */
const boardEl = document.getElementById('board');
const randomBtn = document.getElementById('randomBtn');
const startBtn = document.getElementById('startBtn');
const rndLeftEl = document.getElementById('rndLeft');
const progressEl = document.getElementById('progress');
const darkToggle = document.getElementById('darkToggle');
const langSel = document.getElementById('langSel');
const preHint = document.getElementById('preHint');
const howto = document.getElementById('howto');
const entryModal = document.getElementById('entryModal');
const nameInput = document.getElementById('nameInput');
const respInput = document.getElementById('respInput');
const modalFact = document.getElementById('modalFact');
const modalTitle = document.getElementById('modalTitle');
const cancelBtn = document.getElementById('cancelBtn');
const saveBtn = document.getElementById('saveBtn');
const bingoOverlay = document.getElementById('bingoOverlay');
const bingoText = document.getElementById('bingoText');
const clapAudio = document.getElementById('clapAudio');
const layoutSel = document.getElementById('layoutSel');
const charLimitEl = document.getElementById('charLimit');
const charCountEl = document.getElementById('charCount');
const pageTitle = document.getElementById('pageTitle');

/* App state */
let state = {
  lang: localStorage.getItem('wtaf-lang') || 'en',
  rows: Number(localStorage.getItem('wtaf-rows') || 4),
  cols: Number(localStorage.getItem('wtaf-cols') || 4),
  grid: [],            // indices into facts array; length = rows*cols
  answers: {},         // keyed by tile index
  started: false,
  randomLeft: 3,
  completedLines: new Set(),
  bingoScale: 1,
  winThreshold: 1 // single-line win for all layouts
};

/* Persistence helpers */
function toSavableState(s){
  const copy = {...s};
  copy.completedLines = Array.from(s.completedLines || []);
  return copy;
}
function fromSavedState(s){
  if (!s) return null;
  const revived = {...s};
  revived.completedLines = new Set(Array.isArray(s.completedLines) ? s.completedLines : []);
  return revived;
}
function saveState(){
  try{
    localStorage.setItem('wtaf-state', JSON.stringify(toSavableState(state)));
    localStorage.setItem('wtaf-lang', state.lang);
    localStorage.setItem('wtaf-rows', String(state.rows));
    localStorage.setItem('wtaf-cols', String(state.cols));
    localStorage.setItem('wtaf-winThreshold', String(state.winThreshold));
  }catch(e){ console.warn('save failed', e); }
}
function loadState(){
  try{
    const s = JSON.parse(localStorage.getItem('wtaf-state'));
    const revived = fromSavedState(s);
    if (revived) {
      state = {...state, ...revived};
      if (!state.rows || !state.cols) {
        const size = Number(localStorage.getItem('wtaf-size') || 4);
        state.rows = size; state.cols = size;
      }
    }
  }catch(e){}
}

/* Helpers */
function shuffleArray(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }
function safeEscape(str){ if (str===null||str===undefined) return ''; return String(str).replace(/[&<>\"']/g, s=>({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;',"'":'&#39;'}[s])); }

/* Layout helpers */
function layoutValueFromRowsCols(r,c){ if (r===4 && c===4) return '4x4'; if (r===3 && c===3) return '3x3'; if (r===4 && c===3) return '3x4'; return `${c}x${r}`; }
function setLayoutByValue(val){
  if (val === '4x4'){ state.rows = 4; state.cols = 4; }
  else if (val === '3x3'){ state.rows = 3; state.cols = 3; }
  else if (val === '3x4'){ state.rows = 4; state.cols = 3; } // 3 cols, 4 rows -> rows=4, cols=3
  else {
    const parts = val.split('x').map(Number);
    if (parts.length===2){ state.cols = parts[0]; state.rows = parts[1]; }
  }
  localStorage.setItem('wtaf-rows', String(state.rows));
  localStorage.setItem('wtaf-cols', String(state.cols));
  // always single-line win
  state.winThreshold = 1;
}

/* Grid / Tiles */
function randomiseGrid(){
  const needed = state.rows * state.cols;
  const facts = (I18N[state.lang] && I18N[state.lang].facts) ? I18N[state.lang].facts : I18N.en.facts;
  const total = facts.length;
  const indices = [...Array(total).keys()];
  shuffleArray(indices);
  state.grid = indices.slice(0, needed);
  state.answers = {};
  state.completedLines = new Set();
  state.bingoScale = 1;
  renderBoard(); updateProgress(); saveState();
}
function tileTextByIndex(idx){
  const facts = (I18N[state.lang] && I18N[state.lang].facts) ? I18N[state.lang].facts : I18N.en.facts;
  return facts && typeof state.grid[idx] !== 'undefined' && facts[state.grid[idx]] ? String(facts[state.grid[idx]]) : '';
}
function tileIconByIndex(idx){ const factIdx = state.grid[idx]; return ICONS[factIdx] || { fa:'fa-circle-question', emoji:'‚ùì' }; }

/* Render board */
function renderBoard(){
  const R = state.rows, C = state.cols;
  const totalTiles = R * C;
  if (!Array.isArray(state.grid) || state.grid.length !== totalTiles){ randomiseGrid(); return; }

  boardEl.innerHTML = '';
  boardEl.style.gridTemplateColumns = `repeat(${C}, 1fr)`;
  for (let i=0;i<totalTiles;i++){
    const fact = tileTextByIndex(i);
    const icon = tileIconByIndex(i);
    const entry = state.answers[i];
    const tile = document.createElement('button');
    tile.type = 'button';
    tile.className = 'tile';
    tile.dataset.index = i;
    const faHtml = `<i class="fa-solid ${icon.fa} fa-icon" aria-hidden="true" style="display:none"></i>`;
    const emojiHtml = `<span class="emoji-fallback" aria-hidden="true">${icon.emoji}</span>`;
    tile.innerHTML = `
      ${faHtml}
      ${emojiHtml}
      <div class="fact">${safeEscape(fact)}</div>
      <div class="meta"><span class="who">${ entry ? safeEscape(entry.name) : '' }</span></div>
      ${ entry ? `<div class="entry"><div class="resp">${safeEscape(entry.resp)}</div></div>` : '' }
    `;
    if (entry) tile.classList.add('filled');
    tile.addEventListener('click', ()=> onTileClick(i, fact));
    boardEl.appendChild(tile);
  }
}

/* Modal behavior */
let currentIdx = null;
function onTileClick(idx, fact){
  if (!state.started) return;
  currentIdx = idx;
  modalFact.textContent = fact;
  nameInput.value = state.answers[idx]?.name || '';
  respInput.value = state.answers[idx]?.resp || '';
  // set maxlength and charcount
  respInput.maxLength = RESPONSE_CHAR_LIMIT;
  charLimitEl.textContent = RESPONSE_CHAR_LIMIT;
  updateCharCount();
  try { entryModal.showModal(); } catch(e){ entryModal.setAttribute('open',''); }
  setTimeout(()=> nameInput.focus(), 50);
}

function updateCharCount(){
  const left = RESPONSE_CHAR_LIMIT - (respInput.value ? respInput.value.length : 0);
  charCountEl.textContent = `${left} left`;
}
respInput.addEventListener('input', ()=> {
  if (respInput.value.length > RESPONSE_CHAR_LIMIT) respInput.value = respInput.value.slice(0, RESPONSE_CHAR_LIMIT);
  updateCharCount();
});

/* Save */
function limitWords(str, maxWords){
  const words = str.trim().split(/\s+/).filter(Boolean);
  if (words.length <= maxWords) return { text: words.join(' '), truncated: false };
  return { text: words.slice(0, maxWords).join(' ') + '‚Ä¶', truncated: true };
}
saveBtn.addEventListener('click', (e)=>{
  e.preventDefault();
  const name = nameInput.value.trim();
  const resp = respInput.value.trim();
  if (!name || !resp) return;
  const limited = limitWords(resp, 40);
  const finalResp = limited.text.slice(0, RESPONSE_CHAR_LIMIT);
  state.answers[currentIdx] = { name: name, resp: finalResp };
  try { entryModal.close(); } catch(e){ entryModal.removeAttribute('open'); }
  renderBoard();
  checkForNewBingo();
  updateProgress();
  saveState();
});
cancelBtn.addEventListener('click', (e)=>{ e.preventDefault(); try { entryModal.close(); } catch(e){ entryModal.removeAttribute('open'); } });

/* Bingo lines calculation */
function calculateBingoLines(){
  const R = state.rows, C = state.cols;
  const filled = new Set(Object.keys(state.answers).map(Number));
  const lines = [];
  // rows
  for (let r=0;r<R;r++){
    const row = [];
    for (let c=0;c<C;c++) row.push(r*C + c);
    lines.push(row);
  }
  // cols
  for (let c=0;c<C;c++){
    const col = [];
    for (let r=0;r<R;r++) col.push(r*C + c);
    lines.push(col);
  }
  // diagonals (only if square)
  if (R === C){
    const diag1 = []; for (let i=0;i<R;i++) diag1.push(i*C + i); lines.push(diag1);
    const diag2 = []; for (let i=0;i<R;i++) diag2.push(i*C + (C-1-i)); lines.push(diag2);
  }
  const completed = new Set();
  lines.forEach((l,i)=>{ if (l.every(x=>filled.has(x))) completed.add(i); });
  return completed;
}

/* Progress / bingo */
function updateProgress(){
  const filled = Object.keys(state.answers).length;
  const total = state.rows * state.cols;
  const lines = calculateBingoLines();
  const ui = (I18N[state.lang] && I18N[state.lang].ui) ? I18N[state.lang].ui : I18N.en.ui;

  let base = `${ui.filled(filled, total)} ¬∑ ${ui.lines(lines.size)}`;
  if (state.winThreshold > 1) base += ` ¬∑ Need ${state.winThreshold} lines`;
  progressEl.textContent = base;
}
function playClapSound(){
  if (clapAudio && typeof clapAudio.play === 'function'){
    try { clapAudio.volume = 0.28; clapAudio.currentTime = 0; clapAudio.play().catch(()=>{}); } catch(e){}
    return;
  }
}
function showBingo(){
  bingoOverlay.classList.add('show');
  bingoText.style.transform = `scale(${state.bingoScale})`;
  bingoText.textContent = 'BINGO!';
  const duration = 1200; const end = Date.now() + duration;
  (function frame(){
    confetti({ particleCount: 6, spread: 60, startVelocity: 32, origin: { x: Math.random(), y: Math.random()*0.35 }});
    if (Date.now() < end) requestAnimationFrame(frame);
  })();
}
bingoOverlay.addEventListener('click', ()=> bingoOverlay.classList.remove('show'));

/* Check for new bingo (single-line threshold) */
function checkForNewBingo(){
  const now = calculateBingoLines();
  const prev = (state.completedLines instanceof Set) ? state.completedLines : new Set();
  const newLines = [...now].filter(i=>!prev.has(i));
  if (newLines.length){
    state.completedLines = now;
    if (now.size >= state.winThreshold && prev.size < state.winThreshold) {
      state.bingoScale *= 1.5; playClapSound(); showBingo();
    }
  }
  updateProgress();
  saveState();
}

/* Controls wiring */
randomBtn.addEventListener('click', ()=>{
  if (state.started) return;
  if (state.randomLeft <= 0) return;
  state.randomLeft--; rndLeftEl.textContent = state.randomLeft;
  randomiseGrid();
});

startBtn.addEventListener('click', ()=>{
  const ui = I18N[state.lang].ui;
  if (!state.started){
    state.started = true; saveState();
    preHint.style.display = 'none';
    startBtn.classList.remove('primary');
    startBtn.innerHTML = `‚Ü∫ ${ui.reset}`;
    randomBtn.disabled = true;
  } else {
    state.started = false; state.answers = {}; state.completedLines = new Set(); state.bingoScale = 1;
    state.randomLeft = 3; rndLeftEl.textContent = '3';
    startBtn.classList.add('primary'); startBtn.innerHTML = `‚ñ∂ ${ui.start}`;
    randomBtn.disabled = false;
    renderBoard(); updateProgress(); saveState();
  }
});

/* Dark toggle */
function updateDarkToggleLabel(){
  const ui = (I18N[state.lang] && I18N[state.lang].ui) ? I18N[state.lang].ui : I18N.en.ui;
  if (document.body.classList.contains('dark')) darkToggle.textContent = `‚òÄ ${ui.light || 'Light mode'}`;
  else darkToggle.textContent = `üåô ${ui.dark || 'Dark mode'}`;
}
darkToggle.addEventListener('click', ()=>{
  document.body.classList.toggle('dark');
  darkToggle.setAttribute('aria-pressed', document.body.classList.contains('dark') ? 'true' : 'false');
  localStorage.setItem('wtaf-dark', document.body.classList.contains('dark') ? '1' : '0');
  updateDarkToggleLabel();
});

/* Language */
langSel.addEventListener('change', ()=>{ state.lang = langSel.value; applyLang(); });

/* Layout selector */
layoutSel.addEventListener('change', ()=>{
  setLayoutByValue(layoutSel.value);
  state.started = false;
  state.answers = {};
  state.completedLines = new Set();
  state.randomLeft = 3; rndLeftEl.textContent = String(state.randomLeft);
  randomiseGrid();
  applyLang();
  updateProgress();
});

/* Font A+/A- */
const FONT_MIN = 12, FONT_MAX = 22;
function getSavedFontSize(){ const v = parseInt(localStorage.getItem('wtaf-fontsize') || '', 10); return Number.isFinite(v) ? v : 16; }
function setFontSize(px){ const clamped = Math.max(FONT_MIN, Math.min(FONT_MAX, Math.round(px))); document.documentElement.style.setProperty('--ui-font-size', clamped + 'px'); localStorage.setItem('wtaf-fontsize', String(clamped)); }
document.getElementById('fontInc').addEventListener('click', ()=>{ const cur = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--ui-font-size')||'16',10); setFontSize(cur+1); renderBoard(); });
document.getElementById('fontDec').addEventListener('click', ()=>{ const cur = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--ui-font-size')||'16',10); setFontSize(cur-1); renderBoard(); });

/* Boot */
loadState();
document.body.classList.toggle('dark', localStorage.getItem('wtaf-dark') === '1');
rndLeftEl.textContent = state.randomLeft;
setFontSize(getSavedFontSize());
applyLang();
if (!Array.isArray(state.grid) || state.grid.length !== state.rows * state.cols) {
  state.winThreshold = 1; // ensure single-line win on load
  randomiseGrid();
}
if (state.started){ startBtn.classList.remove('primary'); startBtn.innerHTML = `‚Ü∫ ${I18N[state.lang].ui.reset}`; randomBtn.disabled = true; }

/* Apply language and UI */
function applyLang(){
  langSel.value = state.lang;
  layoutSel.value = layoutValueFromRowsCols(state.rows, state.cols);
  const ui = (I18N[state.lang] && I18N[state.lang].ui) ? I18N[state.lang].ui : I18N.en.ui;
  preHint.textContent = ui.prehint;
  howto.textContent = ui.howto;
  modalTitle.textContent = ui.add;
  if (state.started) startBtn.innerHTML = `‚Ü∫ ${ui.reset}`; else startBtn.innerHTML = `‚ñ∂ ${ui.start}`;
  updateDarkToggleLabel();
  document.title = `Who the Fact Are You? ‚Äî ${layoutValueFromRowsCols(state.rows, state.cols)} Bingo`;
  if (pageTitle) pageTitle.textContent = `Who the Fact Are You? (${layoutValueFromRowsCols(state.rows, state.cols)}) üéâ`;
  renderBoard();
  updateProgress();
  saveState();
}

/* detect FontAwesome (emoji fallback OK) */
function detectFontAwesome(){ try{ if (document.fonts && document.fonts.check("1em 'Font Awesome 6 Free'")) document.body.classList.add('fa-loaded'); else document.body.classList.remove('fa-loaded'); } catch(e){ document.body.classList.remove('fa-loaded'); } }
if (document.fonts && document.fonts.ready) document.fonts.ready.then(detectFontAwesome); else setTimeout(detectFontAwesome, 400);

/* small self-test */
(function runSelfTests(){ console.groupCollapsed('WTFAY self-tests'); const tmp = { completedLines: new Set([1,2,7]) }; const s = JSON.stringify(toSavableState(tmp)); const r = fromSavedState(JSON.parse(s)); console.assert(r.completedLines instanceof Set, 'revived set'); console.assert(r.completedLines.has(7), 'contains 7'); console.groupEnd(); })();
</script>
</body>
</html>
