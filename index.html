<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Who the Fact Are You? ‚Äî Bingo</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>

<style>
  :root{
    --ui-font-size: 16px;
    --brand-red: #e53935;
    --bg: #ffffff;
    --text: #111111;
    --muted: #6b7280;
    --tile: #fafafa;
    --tile-border: #ececec;
    --accent: #ef4444;
    --bingo-green: #22c55e;
    --praise-bg: linear-gradient(135deg,#ffd166,#ff8c42);
    --praise-color: #1b1b1b;
  }
  body.dark{
    --bg:#0b0e16; --text:#ffffff; --muted:#9ca3af; --tile:#0b1220; --tile-border:#16202a; --accent:#f87171;
    --praise-bg: linear-gradient(135deg,#8be9a8,#57e389);
    --praise-color: #051017;
  }
  *{ box-sizing: border-box; }
  html { font-size: var(--ui-font-size); }
  body{ margin:0; font-family: "Poppins", system-ui, -apple-system, "Segoe UI", Roboto, Arial; background:var(--bg); color:var(--text); -webkit-text-size-adjust:100%; }

  .app-wrapper{ min-height:100dvh; border:10px solid var(--brand-red); display:flex; flex-direction:column; }

  header{
    padding: calc(0.75rem + 6px) 1rem;
    display:flex; gap:0.75rem; align-items:center;
  }
  .logo{ width:3.2rem; height:3.2rem; object-fit:contain; border-radius:0.5rem; background:#fff; flex:0 0 auto; margin-right:0.5rem; z-index:2; }
  .brand{ display:flex; flex-direction:column; align-items:flex-start; flex:1 1 auto; min-width:0; }
  .brand .subtitle{ font-size:0.75rem; color:var(--muted); text-transform:uppercase; margin:0 0 0.125rem 0; }
  .brand .title{ font-weight:800; font-size:clamp(18px, 4.5vw, 28px); margin:0; line-height:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; padding-left:0; transition: all .18s ease; }

  .controls{ padding:0.5rem 1rem; display:flex; gap:0.5rem; flex-wrap:wrap; align-items:center; }
  .btn{ padding:0.5rem 0.75rem; border-radius:999px; border:1px solid var(--tile-border); background:var(--tile); color:var(--text); cursor:pointer; font-size:1rem; }
  .btn.primary{ background:var(--accent); color:#fff; border:none; }
  .hint{ font-size:0.8125rem; color:var(--muted); }
  .font-controls{ display:inline-flex; gap:0.5rem; align-items:center; }

  .board-container{ padding:0.5rem 1rem 1rem; flex:1; }
  .board{ display:grid; gap:0.75rem; align-items:stretch; position:relative; overflow:visible; }

  .tile{
    background:var(--tile); border:1px solid var(--tile-border); border-radius:0.875rem;
    display:flex; flex-direction:column; position:relative; padding:0.75rem 0.75rem 3.0rem 0.75rem; overflow:hidden;
    min-height:6.5rem; color:var(--text); text-align:left;
    transition: box-shadow .12s ease, transform .08s ease, background .12s ease, outline-color .12s ease;
  }
  .tile:active { transform: translateY(1px); }

  .fact{ font-size: 0.95rem; line-height:1.25; font-weight:600; margin-bottom:0.5rem; color:var(--text); word-break:break-word; }
  .meta{ margin-top:auto; font-size: 0.825rem; color:var(--muted); display:flex; gap:0.5rem; align-items:center; }
  .entry{ margin-top:0.5rem; font-size: 0.875rem; color:var(--text); }
  .who{ font-weight:700; word-break:break-word; white-space:normal; max-width:100%; font-size:0.95rem; }
  .resp{ margin-top:0.25rem; opacity:0.95; font-size:0.875rem; }

  .fa-icon{ position:absolute; right:0.625rem; bottom:0.625rem; opacity:.22; font-size:1.6rem; display:none; pointer-events:none; }
  .emoji-fallback{ position:absolute; right:0.625rem; bottom:0.625rem; opacity:.22; font-size:1.6rem; display:inline-block; pointer-events:none; }

  .tile.filled {
    outline: 3px solid var(--bingo-green);
    box-shadow: 0 8px 26px rgba(34,197,94,0.07);
    background: linear-gradient(180deg, rgba(34,197,94,0.06), var(--tile));
  }
  .tile.filled .meta::before{
    content: '';
    width: 10px; height: 10px; background: var(--bingo-green); border-radius: 50%; display:inline-block; margin-right:6px; box-shadow:0 1px 0 rgba(0,0,0,0.06);
  }
  .tile.filled .emoji-fallback { opacity: 1; }

  dialog.modal{ border:none; border-radius:0.75rem; padding:0; width:min(40rem,94vw); background:var(--tile); color:var(--text); }
  dialog.modal::backdrop{ background: rgba(0,0,0,0.35); }
  .modal .inner{ padding:0.875rem; }
  .modal .hint{ color:var(--text); font-weight:800; margin-bottom:0.5rem; }
  .modal input, .modal textarea{ width:100%; padding:0.5rem 0.75rem; border-radius:0.625rem; border:1px solid var(--tile-border); background:var(--bg); color:var(--text); font-size:16px; }
  .modal .actions{ display:flex; justify-content:flex-end; gap:0.5rem; margin-top:0.5rem; }
  .modal .btn{ color:var(--text); background:transparent; border:1px solid var(--tile-border); padding:0.5rem 0.75rem; border-radius:0.5rem; }
  .modal .btn.primary{ background:var(--accent); color:#fff; border:none; }

  .bingo-overlay{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.35); z-index:9999; }
  .bingo-overlay.show{ display:flex; }
  .bingo-text{ font-weight:900; font-size:4rem; color:#fff; text-shadow:0 6px 22px rgba(0,0,0,.55); transform: scale(1); white-space:nowrap; }

  /* Stacked center column: BINGO (top), PRAISE (middle), EFFECTS (bottom) */
  .center-stack{ position:fixed; left:50%; top:50%; transform:translate(-50%,-50%); display:flex; flex-direction:column; align-items:center; gap:12px; z-index:10000; pointer-events:none; }
  .praise {
    background:var(--praise-bg);
    color:var(--praise-color);
    padding:12px 14px;
    border-radius:12px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.18);
    font-weight:800;
    max-width: 92vw;
    cursor: pointer;
    transition: transform 180ms cubic-bezier(.2,.9,.3,1), opacity 160ms ease;
    opacity:0;
    pointer-events:auto;
    display:flex;
    align-items:center;
    gap:10px;
  }
  .praise.visible { opacity:1; transform: scale(1); }
  .praise.hidden { opacity:0; transform: scale(.98); pointer-events:none; }

  /* Effects wrapper sits directly under praise in the stack */
  .effects-wrap { width:100%; display:flex; justify-content:center; align-items:center; min-height:64px; pointer-events:none; }
  .effect-item{ position:relative; }

  /* Slow, looped animations (~5s) */
  @keyframes parade-move { 0% { transform: translateX(-45vw); } 100% { transform: translateX(45vw); } }
  @keyframes barrel-roll { 0%{ transform: translateX(-45vw) rotate(0deg) } 100%{ transform: translateX(45vw) rotate(720deg) } }
  @keyframes pokeball-throw { 0% { transform: translateX(-45vw) rotate(0deg) } 100% { transform: translateX(45vw) rotate(360deg) } }
  @keyframes thumb-breathe { 0%{ transform:scale(.8) } 50%{ transform:scale(1.05) } 100%{ transform:scale(.8) } }
  @keyframes chef-breathe { 0%{ transform:scale(.85) } 50%{ transform:scale(1.05) } 100%{ transform:scale(.85) } }
  @keyframes divine-fade { 0%{ opacity:.2 } 50%{ opacity:.95 } 100%{ opacity:.2 } }
  @keyframes eyes-pop { 0%{ opacity:.3; transform:scale(.9) } 50%{ opacity:1; transform:scale(1.06) } 100%{ opacity:.3; transform:scale(.9) } }
  @keyframes slash-fade { 0%{ opacity:0 } 20%{ opacity:1 } 80%{ opacity:1 } 100%{ opacity:0 } }
  @keyframes clapper-pop { 0%{ opacity:0; transform:translateY(-20px) } 50%{ opacity:1; transform:translateY(0) } 100%{ opacity:0; transform:translateY(-20px) } }

  .parade { display:flex; gap:14px; animation: parade-move 5s linear infinite; }
  .parade span { font-size: 28px; filter: drop-shadow(0 6px 8px rgba(0,0,0,0.12)); }

  .barrel { font-size:40px; animation: barrel-roll 5s linear infinite; }
  .pokeball { font-size:40px; animation: pokeball-throw 5s ease-in-out infinite; display:inline-block; }
  .thumbup { font-size:86px; animation: thumb-breathe 5s ease-in-out infinite; }
  .chefkiss { font-size:48px; animation: chef-breathe 5s ease-in-out infinite; }
  .divine { width:240px; height:120px; background: radial-gradient( circle at 50% 50%, rgba(255,255,210,0.6), rgba(255,255,210,0.15) 40%, transparent 75%); opacity:.9; animation: divine-fade 5s linear infinite; border-radius:16px; position:relative; }
  .glow-eyes { position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); font-size:40px; animation: eyes-pop 5s ease-in-out infinite; }
  .leaderboard { background:#fff; color:#111; padding:10px 12px; border-radius:8px; box-shadow:0 10px 30px rgba(0,0,0,.18); width:min(280px,90vw); text-align:left; }
  .slash { width:260px; height:20px; position:relative; }
  .slash .line { position:absolute; left:0; top:7px; height:6px; background: linear-gradient(90deg, rgba(255,255,255,0), rgba(255,255,255,0.95), rgba(255,255,255,0)); width:100%; mix-blend-mode:screen; filter: drop-shadow(0 8px 18px rgba(255,255,255,0.15)); animation: slash-fade 5s linear infinite; }
  .clapper { font-size:42px; animation: clapper-pop 5s ease-in-out infinite; }

  .cinematic-bar { width:100vw; height:60px; background:#000; opacity:.9; }

  footer{ padding:0.5rem 1rem 1rem; display:flex; justify-content:space-between; gap:0.5rem; color:var(--muted); font-size:0.9rem; }

  @media (max-width:760px){
    header{ padding:0.5rem 0.75rem; gap:0.5rem; }
    .logo{ width:2.4rem; height:2.4rem; flex:0 0 auto; margin-right:0.5rem; }
    .brand{ align-items:flex-start; }
    .brand .title { font-size: clamp(16px, 6vw, 20px); white-space:normal; line-height:1.02; }
    .tile{ padding:0.625rem 0.625rem 2.5rem 0.625rem; min-height:5.75rem; }
    .bingo-text{ font-size:3rem; }
    .modal input, .modal textarea{ font-size:16px; }
  }
</style>
</head>
<body>
  <div class="app-wrapper" id="app">
    <header>
      <img class="logo" src="https://tse2.mm.bing.net/th/id/OIP.vB2_MMCK6wxXLJRR_2APTgAAAA?r=0&rs=1&pid=ImgDetMain&o=7&rm=3" alt="Logo"
           onerror="this.src='https://via.placeholder.com/120x40?text=Logo'"/>
      <div class="brand">
        <div class="subtitle" id="subtitle">ENGAGE SQUARED</div>
        <h1 class="title" id="pageTitle">Who the Fact Are You? üéâ</h1>
      </div>
      <div style="width:3.5rem; flex:0 0 auto;"></div>
    </header>

    <div class="controls" role="region" aria-label="controls">
      <div style="display:flex;gap:0.5rem;align-items:center;flex-wrap:wrap;">
        <select id="langSel" aria-label="Language" class="btn">
          <option value="en">English</option>
          <option value="ja">Êó•Êú¨Ë™û</option>
          <option value="id">Bahasa Indonesia</option>
        </select>
        <button id="darkToggle" class="btn" aria-pressed="false">üåô Dark mode</button>
      </div>

      <div style="display:flex; gap:0.5rem; align-items:center; flex-wrap:wrap; margin-left:8px;">
        <label for="layoutSel" class="hint" style="display:inline-flex; align-items:center; gap:0.375rem;">
          <select id="layoutSel" class="btn" aria-label="Board layout">
            <option value="4x4">4√ó4</option>
            <option value="3x3">3√ó3</option>
            <option value="3x4">3√ó4</option>
          </select>
        </label>

        <button id="randomBtn" class="btn">üîÄ <span data-i18n="randomize">Randomise board</span> (<span id="rndLeft">3</span>)</button>
        <button id="startBtn" class="btn primary">‚ñ∂ <span data-i18n="start">Start Bingo</span></button>

        <div class="font-controls" style="margin-left:0.5rem;">
          <button id="fontDec" class="btn" title="Decrease font">A‚àí</button>
          <button id="fontInc" class="btn" title="Increase font">A+</button>
        </div>

        <div id="preHint" class="hint" style="margin-left:0.5rem;">You can shuffle up to 3√ó before starting.</div>
      </div>

      <div style="margin-left:auto;" class="hint" id="howto">Tap a tile to enter a name + a short response. Fill lines to get BINGO!</div>
    </div>

    <div class="board-container">
      <main id="board" class="board" aria-live="polite"></main>
    </div>

    <footer>
      <div id="progress">0/16 filled ¬∑ 0 bingo lines</div>
      <div>Made with ‚ù§Ô∏è by your friendly neighbourhood Liam</div>
    </footer>
  </div>

  <!-- Center stack: BINGO (top), Praise (middle), Effects (bottom) -->
  <div class="bingo-overlay" id="bingoOverlay" aria-hidden="true">
    <div class="center-stack" id="centerStack">
      <div class="bingo-text" id="bingoText">BINGO!</div>
      <div id="praise" class="praise hidden" role="button" aria-live="polite" title="Click to dismiss"></div>
      <div class="effects-wrap"><div id="effects" class="effect-item"></div></div>
    </div>
  </div>

  <dialog class="modal" id="entryModal">
    <form method="dialog" class="inner" onsubmit="return false;">
      <h3 id="modalTitle">Add a name & response</h3>
      <div id="modalFact" class="hint" style="margin-bottom:8px;"></div>

      <label id="nameLabel" for="nameInput">Name</label>
      <input id="nameInput" type="text" placeholder="Type their name" required style="margin-bottom:8px; font-size:16px;" maxlength="40" />

      <label id="respLabel" for="respInput">Response</label>
      <textarea id="respInput" placeholder="A few words‚Ä¶" required style="font-size:16px;" rows="3"></textarea>
      <div style="display:flex; justify-content:space-between; align-items:center; margin-top:6px;">
        <div class="hint" id="respHint">Max <span id="charLimit">60</span> chars</div>
        <div class="hint" id="charCount">60 left</div>
      </div>

      <div class="actions" style="margin-top:8px;">
        <button id="cancelBtn" class="btn" value="cancel">Cancel</button>
        <button id="saveBtn" class="btn primary" value="confirm">Save</button>
      </div>
    </form>
  </dialog>

<script>
/* Config */
const RESPONSE_CHAR_LIMIT = 60;

/* I18N ‚Äî full facts + praises across languages */
const I18N = {
  en: {
    ui: {
      randomize: 'Randomise board',
      start: 'Start Bingo',
      reset: '‚Ü∫ Reset',
      preHint: 'You can shuffle up to 3√ó before starting.',
      howto: 'Tap a tile then add a name & short response. Fill lines to get BINGO!',
      modalTitle: 'Add a name & response',
      nameLabel: 'Name',
      respLabel: 'Response',
      respHint: 'Max {n} chars',
      cancel: 'Cancel',
      save: 'Save',
      darkMode: 'üåô Dark mode',
      lightMode: '‚òÄ Light mode',
      filled: (n, total) => `${n}/${total} filled`,
      lines: (n) => `${n} bingo line${n === 1 ? '' : 's'}`
    },
    facts: [
      '‚Ä¶has worked at the company for over 10 years',
      '‚Ä¶has a hidden talent they‚Äôve performed publicly',
      '‚Ä¶has travelled to more than 5 countries',
      '‚Ä¶speaks more than two languages',
      '‚Ä¶has met someone famous',
      '‚Ä¶has run a marathon or completed a major fitness challenge',
      '‚Ä¶has a pet that‚Äôs not a dog or cat',
      '‚Ä¶has lived in more than three cities',
      '‚Ä¶has the same birth month as you',
      '‚Ä¶has worked in a completely different industry before',
      '‚Ä¶has a side hustle or passion project',
      '‚Ä¶has been with the company less than 6 months',
      '‚Ä¶has a unique hobby (e.g., beekeeping, pottery, fencing)',
      '‚Ä¶has never had coffee',
      '‚Ä¶has been on TV or radio',
      '‚Ä¶has a twin or is a twin',
      '‚Ä¶has gone skydiving or bungee jumping',
      '‚Ä¶has a tattoo with a story behind it',
      '‚Ä¶has attended a concert in the last month',
      '‚Ä¶has read more than 20 books this year',
      '‚Ä¶has worked remotely from another country',
      '‚Ä¶has a collection of something unusual',
      '‚Ä¶has been part of a theatre production',
      '‚Ä¶has a nickname they still go by',
      '‚Ä¶has won a competition or award',
      '‚Ä¶has a favourite podcast they recommend',
      '‚Ä¶has a bucket list item they‚Äôve completed',
      '‚Ä¶has a go-to karaoke song',
      '‚Ä¶can do a celebrity impression on the spot',
      '‚Ä¶has a weird food combo they love (and will defend)',
      '‚Ä¶has a pet with a human name',
      '‚Ä¶has tried an extreme sport (and survived)',
      '‚Ä¶has been mistaken for someone famous',
      '‚Ä¶has a viral TikTok or Reel (or knows someone who does)',
      '‚Ä¶has a favourite emoji they overuse',
      '‚Ä¶has a favourite conspiracy theory (for fun!)',
      '‚Ä¶has a favourite fictional character they relate to',
      '‚Ä¶has a story about a travel fail',
      '‚Ä¶has a favourite board game or card game',
      '‚Ä¶has a food they refuse to eat under any circumstance'
    ],
    praises: [
      { text: 'Bingo! Now do it again ‚Äî the world depends on it', effect: null },
      { text: "Nice one! You're a human confetti machine.", effect: null },
      { text: 'Whoa ‚Äî that deserves a tiny parade. Keep going!', effect: null },
      { text: 'Amazing ‚Äî your bingo skills are trending locally.', effect: null },
      { text: "That's one. Collect them like they're rare snacks.", effect: null },
      { text: 'Solid work. More bingos, less sleep!', effect: null },
      { text: "Hot dang ‚Äî you're on a bingo roll. Roll harder.", effect: null },
      { text: 'Impressive! Rewards: bragging rights and vibes', effect: null },
      { text: 'You caught one ‚Äî go catch the rest like Pok√©mon', effect: null },
      { text: 'Beautifully done. Next target: world domination (or another bingo)', effect: null },
      { text: 'That‚Äôs a thumb up from fate. Get greedy', effect: null },
      { text: "Chef's kiss. Serve another bingo, please", effect: null },
      { text: 'A bingo a day keeps boredom away. Keep collecting!', effect: null },
      { text: 'Bingo is a dish best served multiple times', effect: null },
      { text: 'You‚Äôve got more Bingos in you. I can feel it!', effect: null },
      { text: 'That was just your warm-up round, right?', effect: null },
      { text: 'Don‚Äôt stop now ‚Äî the Bingo gods are watching', effect: null },
      { text: 'One Bingo? Cute', effect: null },
      { text: 'You just made the Bingo Hall of Fame. Probably.', effect: null },
      { text: 'Bingo unlocked. Next level: Legend', effect: null },
      { text: 'Bingo? More like Bing-WHOA!', effect: null },
      { text: 'That was a FACTastrophe‚Ä¶ for everyone else', effect: null },
      { text: 'Who needs Google when we‚Äôve got YOU?', effect: null },
      { text: 'You‚Äôre not just playing ‚Äî you‚Äôre fact-slaying', effect:  null },
      { text: 'Keep going ‚Äî the next one‚Äôs got your name on it', effect: null },
      { text: 'That was so good, we‚Äôre renaming the game after you', effect:  null  },
      { text: 'You‚Äôve officially entered your ‚Äòmain character‚Äô Bingo arc', effect: null }
    ]
  },

  ja: {
    ui: {
      randomize: '„Éú„Éº„Éâ„Çí„Ç∑„É£„ÉÉ„Éï„É´',
      start: '„Éì„É≥„Ç¥ÈñãÂßã',
      reset: '‚Ü∫ „É™„Çª„ÉÉ„Éà',
      preHint: 'ÈñãÂßãÂâç„Å´ÊúÄÂ§ß3Âõû„Ç∑„É£„ÉÉ„Éï„É´„Åß„Åç„Åæ„Åô„ÄÇ',
      howto: '„Çø„Ç§„É´„Çí„Çø„ÉÉ„Éó„Åó„Å¶ÂêçÂâç„Å®Áü≠„ÅÑÂõûÁ≠î„ÇíÂÖ•Âäõ„ÄÇÂàó„ÇíÂüã„ÇÅ„Å¶BINGOÔºÅ',
      modalTitle: 'ÂêçÂâç„Å®ÂõûÁ≠î„ÇíËøΩÂä†',
      nameLabel: 'ÂêçÂâç',
      respLabel: 'ÂõûÁ≠î',
      respHint: 'ÊúÄÂ§ß {n} ÊñáÂ≠ó',
      cancel: '„Ç≠„É£„É≥„Çª„É´',
      save: '‰øùÂ≠ò',
      darkMode: 'üåô „ÉÄ„Éº„ÇØ„É¢„Éº„Éâ',
      lightMode: '‚òÄ „É©„Ç§„Éà„É¢„Éº„Éâ',
      filled: (n, total) => `${n}/${total} ÂÖ•ÂäõÊ∏à„Åø`,
      lines: (n) => `${n} „Éì„É≥„Ç¥„É©„Ç§„É≥`
    },
    facts: [
      '‚Ä¶‰ºöÁ§æ„Åß10Âπ¥‰ª•‰∏äÂÉç„ÅÑ„Å¶„ÅÑ„Çã',
      '‚Ä¶Èö†„Çå„ÅüÁâπÊäÄ„Åå„ÅÇ„Çä‰∫∫Ââç„ÅßÊä´Èú≤„Åó„Åü„Åì„Å®„Åå„ÅÇ„Çã',
      '‚Ä¶5„ÅãÂõΩ‰ª•‰∏ä„ÇíÊóÖË°å„Åó„Åü„Åì„Å®„Åå„ÅÇ„Çã',
      '‚Ä¶2Ë®ÄË™û‰ª•‰∏ä„ÇíË©±„Åõ„Çã',
      '‚Ä¶ÊúâÂêç‰∫∫„Å´‰ºö„Å£„Åü„Åì„Å®„Åå„ÅÇ„Çã',
      '‚Ä¶„Éû„É©„ÇΩ„É≥ÂÆåËµ∞„ÇÑÂ§ß„Åç„Å™„Éï„Ç£„ÉÉ„Éà„Éç„ÇπÊåëÊà¶„ÇíÈÅîÊàê„Åó„Åü',
      '‚Ä¶Áä¨„ÇÑÁå´‰ª•Â§ñ„ÅÆ„Éö„ÉÉ„Éà„ÇíÈ£º„Å£„Å¶„ÅÑ„Çã',
      '‚Ä¶3ÈÉΩÂ∏Ç‰ª•‰∏ä„Å´‰Ωè„Çì„Å†„Åì„Å®„Åå„ÅÇ„Çã',
      '‚Ä¶„ÅÇ„Å™„Åü„Å®Âêå„ÅòË™ïÁîüÊúà',
      '‚Ä¶„Åæ„Å£„Åü„ÅèÂà•„ÅÆÊ•≠Áïå„ÅßÂÉç„ÅÑ„Å¶„ÅÑ„Åü„Åì„Å®„Åå„ÅÇ„Çã',
      '‚Ä¶ÂâØÊ•≠„ÇÑÊÉÖÁÜ±„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÇíÊåÅ„Å£„Å¶„ÅÑ„Çã',
      '‚Ä¶ÂÖ•Á§æ„Åó„Å¶6„ÅãÊúàÊú™Ê∫Ä',
      '‚Ä¶„É¶„Éã„Éº„ÇØ„Å™Ë∂£Âë≥„Åå„ÅÇ„ÇãÔºà‰æãÔºöÈ§äËúÇ„ÄÅÈô∂Ëä∏„ÄÅ„Éï„Çß„É≥„Ç∑„É≥„Ç∞Ôºâ',
      '‚Ä¶„Ç≥„Éº„Éí„Éº„ÇíÈ£≤„Çì„Å†„Åì„Å®„Åå„Å™„ÅÑ',
      '‚Ä¶„ÉÜ„É¨„Éì„ÇÑ„É©„Ç∏„Ç™„Å´Âá∫„Åü„Åì„Å®„Åå„ÅÇ„Çã',
      '‚Ä¶ÂèåÂ≠ê„ÄÅ„Åæ„Åü„ÅØÂèåÂ≠ê„ÅÆÂÖÑÂºüÂßâÂ¶π„Åå„ÅÑ„Çã',
      '‚Ä¶„Çπ„Ç´„Ç§„ÉÄ„Ç§„Éì„É≥„Ç∞„ÇÑ„Éê„É≥„Ç∏„Éº„Çí„Åó„Åü„Åì„Å®„Åå„ÅÇ„Çã',
      '‚Ä¶„Çπ„Éà„Éº„É™„Éº„ÅÆ„ÅÇ„Çã„Çø„Éà„Ç•„Éº„Åå„ÅÇ„Çã',
      '‚Ä¶ÂÖàÊúà„É©„Ç§„Éñ„ÇÑ„Ç≥„É≥„Çµ„Éº„Éà„Å´Ë°å„Å£„Åü',
      '‚Ä¶‰ªäÂπ¥20ÂÜä‰ª•‰∏ä„ÅÆÊú¨„ÇíË™≠„Çì„Å†',
      '‚Ä¶Êµ∑Â§ñ„Åã„Çâ„É™„É¢„Éº„ÉàÂã§Âãô„Çí„Åó„Åü',
      '‚Ä¶„Å°„Çá„Å£„Å®Â§â„Çè„Å£„Åü„Ç≥„É¨„ÇØ„Ç∑„Éß„É≥„Åå„ÅÇ„Çã',
      '‚Ä¶ËàûÂè∞„ÇÑÊºîÂäá„Å´ÂèÇÂä†„Åó„Åü„Åì„Å®„Åå„ÅÇ„Çã',
      '‚Ä¶‰ªä„ÇÇ‰Ωø„Å£„Å¶„ÅÑ„Çã„Éã„ÉÉ„ÇØ„Éç„Éº„É†„Åå„ÅÇ„Çã',
      '‚Ä¶„Ç≥„É≥„ÉÜ„Çπ„Éà„ÇÑË≥û„ÅßÂèóË≥ûÁµåÈ®ì„Åå„ÅÇ„Çã',
      '‚Ä¶„Åä„Åô„Åô„ÇÅ„ÅÆ„Éù„ÉÉ„Éâ„Ç≠„É£„Çπ„Éà„Åå„ÅÇ„Çã',
      '‚Ä¶„Éê„Ç±„ÉÉ„Éà„É™„Çπ„Éà„Çí‰∏Ä„Å§ÈÅîÊàê„Åó„Åü',
      '‚Ä¶ÂÆöÁï™„ÅÆ„Ç´„É©„Ç™„Ç±Êõ≤„Åå„ÅÇ„Çã',
      '‚Ä¶„Åù„ÅÆÂ†¥„ÅßËä∏ËÉΩ‰∫∫„ÅÆ„É¢„Éé„Éû„Éç„Åå„Åß„Åç„Çã',
      '‚Ä¶Â§â„Çè„Å£„ÅüÂ•Ω„Åç„Å™È£ü„ÅπÂêà„Çè„Åõ„Åå„ÅÇ„ÇãÔºà„Åù„Åó„Å¶Ë≠≤„Çâ„Å™„ÅÑÔºâ',
      '‚Ä¶‰∫∫„ÅÆÂêçÂâç„ÅÆ„Éö„ÉÉ„Éà„ÇíÈ£º„Å£„Å¶„ÅÑ„Çã',
      '‚Ä¶„Ç®„ÇØ„Çπ„Éà„É™„Éº„É†„Çπ„Éù„Éº„ÉÑ„Å´ÊåëÊà¶„Åó„ÅüÔºàÁîüÈÇÑÔºâ',
      '‚Ä¶ÊúâÂêç‰∫∫„Å´ÈñìÈÅï„Åà„Çâ„Çå„Åü„Åì„Å®„Åå„ÅÇ„Çã',
      '‚Ä¶„Éê„Ç∫„Å£„ÅüTikTok/„É™„Éº„É´„Åå„ÅÇ„ÇãÔºà„Åæ„Åü„ÅØÁü•‰∫∫„Å´„ÅÑ„ÇãÔºâ',
      '‚Ä¶„Å§„ÅÑÂ§öÁî®„Åó„Å¶„Åó„Åæ„ÅÜ„ÅäÊ∞ó„Å´ÂÖ•„ÇäÁµµÊñáÂ≠ó„Åå„ÅÇ„Çã',
      '‚Ä¶Â•Ω„Åç„Å™Èô∞Ë¨ÄË´ñ„Åå„ÅÇ„ÇãÔºà„ÅÇ„Åè„Åæ„ÅßÂ®ØÊ•Ω„Å®„Åó„Å¶Ôºâ',
      '‚Ä¶ÊÑüÊÉÖÁßªÂÖ•„Åß„Åç„Çã„ÅäÊ∞ó„Å´ÂÖ•„Çä„ÅÆÊû∂Á©∫„Ç≠„É£„É©„Åå„ÅÑ„Çã',
      '‚Ä¶ÊóÖ„ÅÆÂ§±ÊïóË´á„Åå„ÅÇ„Çã',
      '‚Ä¶„ÅäÊ∞ó„Å´ÂÖ•„Çä„ÅÆ„Éú„Éº„Éâ„Ç≤„Éº„É†Ôºè„Ç´„Éº„Éâ„Ç≤„Éº„É†„Åå„ÅÇ„Çã',
      '‚Ä¶Áµ∂ÂØæ„Å´È£ü„Åπ„Å™„ÅÑ„Å®Ê±∫„ÇÅ„Å¶„ÅÑ„ÇãÈ£ü„ÅπÁâ©„Åå„ÅÇ„Çã'
    ],
    praises: [
      { text: '„Éì„É≥„Ç¥ÔºÅ„ÇÇ„ÅÜ‰∏ÄÂõû„ÅÑ„Åì„ÅÜ ‚Äî ‰∏ñÁïå„Åå„ÅÇ„Å™„Åü„Å´„Åã„Åã„Å£„Å¶„Çã', effect: null },
      { text: '„Éä„Ç§„ÇπÔºÅ„ÅÇ„Å™„Åü„ÅØ‰∫∫Èñì„Ç≥„É≥„Éï„Çß„ÉÉ„ÉÜ„Ç£„Éû„Ç∑„É≥„Å†', effect: null },
      { text: '„Åä„Åä„Å£ ‚Äî Â∞è„Åï„Å™„Éë„É¨„Éº„ÉâÊ°à‰ª∂ÔºÅ„Åù„ÅÆ„Åæ„ÅæÁ∂ö„Åë„Å¶ÔºÅ', effect:  null  },
      { text: '„Åô„Åî„ÅÑ ‚Äî „ÅÇ„Å™„Åü„ÅÆ„Éì„É≥„Ç¥„Åå„É≠„Éº„Ç´„É´„Åß„Éà„É¨„É≥„ÉâÂÖ•„Çä‰∏≠', effect:  null  },
      { text: '„Åæ„Åö„ÅØ1„Å§„ÄÇ„É¨„Ç¢„Å™„ÅäËèìÂ≠ê„Åø„Åü„ÅÑ„Å´ÈõÜ„ÇÅ„Çà„ÅÜ', effect: null },
      { text: '„ÅÑ„ÅÑÊÑü„Åò„ÄÇ„Éì„É≥„Ç¥„ÇíÂ¢ó„ÇÑ„Åó„Å¶Áù°Áú†„ÅØ„Åª„Å©„Åª„Å©„Å´ÔºÅ', effect: null },
      { text: 'ÁÜ±„ÅÑÔºÅ„Éì„É≥„Ç¥„ÅåËª¢„Åå„Å£„Å¶„Çã„ÄÇ„ÇÇ„Å£„Å®Ëª¢„Åå„Åõ', effect:  null  },
      { text: '„ÅäË¶ã‰∫ãÔºÅ„ÅîË§íÁæéÔºö„Éâ„É§È°î„Å®ËâØ„ÅÑ„Éê„Ç§„Éñ„Çπ', effect: null },
      { text: '1„Å§Êçï„Åæ„Åà„Åü ‚Äî ÊÆã„Çä„ÇÇ„Éù„Ç±„É¢„É≥„ÅÆ„Çà„ÅÜ„Å´ÊçïÁç≤„Å†', effect:  null  },
      { text: 'ÂÆåÁíß„ÄÇÊ¨°„ÅÆÁõÆÊ®ôÔºö‰∏ñÁïåÂæÅÊúçÔºà„Åã„ÄÅ„ÇÇ„ÅÜ‰∏ÄÂõû„Éì„É≥„Ç¥Ôºâ', effect: null },
      { text: 'ÈÅãÂëΩ„Åã„Çâ„ÅÆüëç„ÄÇÂº∑Ê¨≤„Å´„ÅÑ„Åì„ÅÜ', effect:  null  },
      { text: '„Ç∑„Çß„Éï„ÅÆ„Ç≠„Çπ„ÄÇ„Éì„É≥„Ç¥„Åä„Åã„Çè„Çä„ÅäÈ°ò„ÅÑ„Åó„Åæ„Åô', effect:  null  },
      { text: '„Éì„É≥„Ç¥„ÅØÈÄÄÂ±àÈÄÄÊï£„ÅÆ‰∏ÄÁöø„ÄÇÈõÜ„ÇÅÁ∂ö„Åë„Çà„ÅÜÔºÅ', effect: null },
      { text: '‰ªä„ÇÑ„ÇÅ„Çã„Å™ ‚Äî „Éì„É≥„Ç¥„ÅÆÁ•û„ÄÖ„ÅåË¶ã„Å¶„ÅÑ„Çã', effect:  null  },
      { text: '„Éì„É≥„Ç¥ÊÆøÂ†ÇÂÖ•„Çä‚Ä¶„Åã„ÇÇ„Åó„Çå„Å™„ÅÑ', effect:  null  },
      { text: '„ÅÇ„Å™„Åü„ÅÆ„Äå‰∏ª‰∫∫ÂÖ¨„Éì„É≥„Ç¥Á∑®„Äç„ÅåÂßã„Åæ„Å£„Åü', effect: null },
      { text: 'Google„Çà„ÇäÂêõÔºü„ÅÇ„Çä„Åà„Çã', effect: null },
      { text: '„Éó„É¨„Ç§„Åó„Å¶„Çã„Å†„Åë„Åò„ÇÉ„Å™„ÅÑ ‚Äî „Éï„Ç°„ÇØ„ÉàÊñ¨„Çä„Å†', effect:  null  },
      { text: '„Åù„ÅÆË™øÂ≠êÔºÅÊ¨°„ÅÆ1Êú¨„ÅØ„ÅÇ„Å™„Åü„ÅÆÂêçÂâçÂÖ•„Çä', effect: null },
      { text: 'ËâØ„Åô„Åé„Å¶„Ç≤„Éº„É†Âêç„ÇíÂêõ„Å´ÊîπÂêç„Åô„Çã„Åã„ÇÇ', effect:  null  }
    ]
  },

  id: {
    ui: {
      randomize: 'Acak papan',
      start: 'Mulai Bingo',
      reset: '‚Ü∫ Reset',
      preHint: 'Anda dapat mengacak hingga 3√ó sebelum mulai.',
      howto: 'Ketuk ubin lalu tambahkan nama & jawaban singkat. Isi baris untuk dapat BINGO!',
      modalTitle: 'Tambah nama & jawaban',
      nameLabel: 'Nama',
      respLabel: 'Jawaban',
      respHint: 'Maks {n} karakter',
      cancel: 'Batal',
      save: 'Simpan',
      darkMode: 'üåô Mode gelap',
      lightMode: '‚òÄ Mode terang',
      filled: (n, total) => `${n}/${total} terisi`,
      lines: (n) => `${n} baris bingo`
    },
    facts: [
      '‚Ä¶sudah bekerja di perusahaan lebih dari 10 tahun',
      '‚Ä¶punya bakat tersembunyi dan pernah tampil di depan umum',
      '‚Ä¶pernah berkunjung ke lebih dari 5 negara',
      '‚Ä¶bisa berbicara lebih dari dua bahasa',
      '‚Ä¶pernah bertemu orang terkenal',
      '‚Ä¶menyelesaikan maraton atau tantangan kebugaran besar',
      '‚Ä¶memiliki peliharaan selain anjing atau kucing',
      '‚Ä¶pernah tinggal di lebih dari tiga kota',
      '‚Ä¶punya bulan lahir yang sama denganmu',
      '‚Ä¶pernah bekerja di industri yang sangat berbeda',
      '‚Ä¶punya pekerjaan sampingan atau proyek passion',
      '‚Ä¶bergabung kurang dari 6 bulan yang lalu',
      '‚Ä¶punya hobi unik (mis. beternak lebah, tembikar, anggar)',
      '‚Ä¶tidak pernah minum kopi',
      '‚Ä¶pernah tampil di TV atau radio',
      '‚Ä¶adalah anak kembar atau punya kembaran',
      '‚Ä¶pernah terjun payung atau bungee jumping',
      '‚Ä¶punya tato dengan cerita di baliknya',
      '‚Ä¶baru-baru ini nonton konser',
      '‚Ä¶tahun ini membaca lebih dari 20 buku',
      '‚Ä¶pernah kerja jarak jauh dari luar negeri',
      '‚Ä¶mengoleksi sesuatu yang tidak biasa',
      '‚Ä¶pernah ikut produksi teater',
      '‚Ä¶punya panggilan yang masih dipakai',
      '‚Ä¶pernah menang kompetisi atau penghargaan',
      '‚Ä¶punya podcast favorit untuk direkomendasikan',
      '‚Ä¶sudah mencoret satu item dari bucket list',
      '‚Ä¶punya lagu karaoke andalan',
      '‚Ä¶bisa menirukan selebritas secara spontan',
      '‚Ä¶punya kombinasi makanan aneh yang disukai',
      '‚Ä¶punya hewan peliharaan dengan nama manusia',
      '‚Ä¶pernah mencoba olahraga ekstrem (dan selamat)',
      '‚Ä¶pernah disangka orang terkenal',
      '‚Ä¶punya TikTok/Reel viral (atau kenal yang punya)',
      '‚Ä¶punya emoji favorit yang sering dipakai',
      '‚Ä¶punya teori konspirasi favorit (buat seru-seruan)',
      '‚Ä¶punya karakter fiksi favorit yang relate',
      '‚Ä¶punya kisah gagal perjalanan',
      '‚Ä¶punya board game atau card game favorit',
      '‚Ä¶ada makanan yang pantang dimakan kapan pun'
    ],
    praises: [
      { text: 'Bingo! Ulangi lagi ‚Äî dunia bergantung padamu', effect: null },
      { text: 'Mantap! Kamu mesin konfeti manusia.', effect: null },
      { text: 'Whoa ‚Äî pantas dapat parade mini. Lanjut!', effect:  null  },
      { text: 'Luar biasa ‚Äî skill bingomu lagi trending lokal.', effect:  null  },
      { text: 'Satu tercapai. Kumpulkan seperti camilan langka.', effect: null },
      { text: 'Kerja solid. Lebih banyak bingo, kurang tidur!', effect: null },
      { text: 'Panas! Kamu lagi bergulir. Gulir lebih kencang.', effect:  null  },
      { text: 'Keren! Hadiahnya: hak pamer & good vibes', effect: null },
      { text: 'Dapat satu ‚Äî tangkap sisanya seperti Pok√©mon', effect:  null  },
      { text: 'Indah! Target berikut: dominasi dunia (atau bingo lagi)', effect: null },
      { text: 'üëç dari takdir. Jadi lebih serakah.', effect:  null  },
      { text: 'Ciuman chef. Tambah satu bingo lagi ya', effect:  null  },
      { text: 'Satu bingo sehari usir bosan. Terus kumpulkan!', effect: null },
      { text: 'Bingo terbaik disajikan berkali-kali', effect: null },
      { text: 'Masih banyak bingo dalam dirimu. Terasa!', effect: null },
      { text: 'Baru pemanasan kan?', effect: null },
      { text: 'Jangan berhenti ‚Äî dewa-dewa Bingo memperhatikan', effect:  null  },
      { text: 'Satu bingo? Imut.', effect: null },
      { text: 'Kamu masuk Hall of Fame Bingo. Mungkin.', effect:  null  },
      { text: 'Bingo terbuka. Level berikutnya: Legenda', effect: null },
      { text: 'Bingo? Lebih tepat Bing-WHOA!', effect: null },
      { text: 'Itu FACTastrophe‚Ä¶ untuk yang lain', effect: null },
      { text: 'Siapa butuh Google kalau ada KAMU?', effect: null },
      { text: 'Bukan sekadar main ‚Äî kamu membabat fakta', effect:  null  },
      { text: 'Teruskan ‚Äî yang berikutnya atas namamu', effect: null },
      { text: 'Keren banget, game-nya kami ubah jadi versi kamu', effect:  null },
      { text: 'Kamu resmi masuk arc ‚Äúmain character‚Äù Bingomu', effect: null }
    ]
  }
};

/* icons (keep emoji fallback solid) */
const ICONS = [
  { fa:'fa-briefcase', emoji:'üè¢' }, { fa:'fa-masks-theater', emoji:'üé§' }, { fa:'fa-earth-americas', emoji:'üåç' },
  { fa:'fa-language', emoji:'üó£Ô∏è' }, { fa:'fa-star', emoji:'‚≠ê' }, { fa:'fa-person-running', emoji:'üèÉ' },
  { fa:'fa-paw', emoji:'ü¶é' }, { fa:'fa-city', emoji:'üèôÔ∏è' }, { fa:'fa-cake-candles', emoji:'üéÇ' },
  { fa:'fa-rotate', emoji:'üîÑ' }, { fa:'fa-lightbulb', emoji:'üí°' }, { fa:'fa-seedling', emoji:'üÜï' },
  { fa:'fa-palette', emoji:'üé®' }, { fa:'fa-mug-saucer', emoji:'üö´‚òï' }, { fa:'fa-tv', emoji:'üì∫' },
  { fa:'fa-people-arrows', emoji:'üëØ' }, { fa:'fa-parachute-box', emoji:'ü™Ç' }, { fa:'fa-pen-nib', emoji:'üñãÔ∏è' },
  { fa:'fa-music', emoji:'üé∂' }, { fa:'fa-book-open', emoji:'üìö' }, { fa:'fa-laptop-house', emoji:'üíª' },
  { fa:'fa-box-archive', emoji:'üì¶' }, { fa:'fa-masks-theater', emoji:'üé≠' }, { fa:'fa-id-badge', emoji:'üè∑Ô∏è' },
  { fa:'fa-trophy', emoji:'üèÜ' }, { fa:'fa-podcast', emoji:'üéß' }, { fa:'fa-list-check', emoji:'‚úÖ' },
  { fa:'fa-microphone', emoji:'üé§' }, { fa:'fa-face-grin-stars', emoji:'üòé' }, { fa:'fa-burger', emoji:'üçï' },
  { fa:'fa-dog', emoji:'üê∂' }, { fa:'fa-person-skiing', emoji:'üèÑ' }, { fa:'fa-user-check', emoji:'üëÄ' },
  { fa:'fa-mobile-screen', emoji:'üì±' }, { fa:'fa-face-grin', emoji:'üòä' }, { fa:'fa-user-secret', emoji:'üõ∏' },
  { fa:'fa-hat-wizard', emoji:'ü¶∏' }, { fa:'fa-suitcase-rolling', emoji:'üß≥' }, { fa:'fa-chess-board', emoji:'üé≤' },
  { fa:'fa-ban', emoji:'üö´üçΩÔ∏è' }
];

/* DOM refs */
const boardEl = document.getElementById('board');
const randomBtn = document.getElementById('randomBtn');
const startBtn = document.getElementById('startBtn');
const rndLeftEl = document.getElementById('rndLeft');
const progressEl = document.getElementById('progress');
const darkToggle = document.getElementById('darkToggle');
const langSel = document.getElementById('langSel');
const preHint = document.getElementById('preHint');
const howto = document.getElementById('howto');
const entryModal = document.getElementById('entryModal');
const nameInput = document.getElementById('nameInput');
const respInput = document.getElementById('respInput');
const modalFact = document.getElementById('modalFact');
const modalTitle = document.getElementById('modalTitle');
const cancelBtn = document.getElementById('cancelBtn');
const saveBtn = document.getElementById('saveBtn');
const layoutSel = document.getElementById('layoutSel');
const charLimitEl = document.getElementById('charLimit');
const charCountEl = document.getElementById('charCount');
const pageTitle = document.getElementById('pageTitle');
const bingoOverlay = document.getElementById('bingoOverlay');
const bingoText = document.getElementById('bingoText');
const praiseEl = document.getElementById('praise');
const effectsEl = document.getElementById('effects');

/* state */
let state = {
  lang: localStorage.getItem('wtaf-lang') || 'en',
  rows: Number(localStorage.getItem('wtaf-rows') || 4),
  cols: Number(localStorage.getItem('wtaf-cols') || 4),
  grid: [],
  answers: {},
  started: false,
  randomLeft: 3,
  completedLines: new Set(),
  // per-round praise usage (to avoid repeats in the same round)
  roundPraiseUsed: [],
  justShownAt: 0
};

/* persistence */
function saveState(){
  try{
    const copy = {...state};
    copy.completedLines = Array.from(state.completedLines);
    localStorage.setItem('wtaf-state', JSON.stringify(copy));
    localStorage.setItem('wtaf-lang', state.lang);
    localStorage.setItem('wtaf-rows', String(state.rows));
    localStorage.setItem('wtaf-cols', String(state.cols));
  }catch(e){}
}
function loadState(){
  try{
    const s = JSON.parse(localStorage.getItem('wtaf-state') || '{}');
    if (s && typeof s === 'object'){
      if (Array.isArray(s.completedLines)) state.completedLines = new Set(s.completedLines);
      if (s.answers) state.answers = s.answers;
      if (s.grid) state.grid = s.grid;
      if (typeof s.rows === 'number') state.rows = s.rows;
      if (typeof s.cols === 'number') state.cols = s.cols;
      if (typeof s.lang === 'string') state.lang = s.lang;
    }
  }catch(e){}
}

/* helpers */
function shuffleArray(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }
function safeEscape(str){ if (str===null||str===undefined) return ''; return String(str).replace(/[&<>\"']/g, s=>({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;',"'":'&#39;'}[s])); }
function getPraises(){ const p=(I18N[state.lang]&&I18N[state.lang].praises)||I18N.en.praises; return p; }
function getFacts(){ const f=(I18N[state.lang]&&I18N[state.lang].facts)||I18N.en.facts; return f; }
function getUI(){ return (I18N[state.lang] && I18N[state.lang].ui) ? I18N[state.lang].ui : I18N.en.ui; }

function layoutValueFromRowsCols(r,c){ if (r===4 && c===4) return '4x4'; if (r===3 && c===3) return '3x3'; if (r===4 && c===3) return '3x4'; return `${c}x${r}`; }
function setLayoutByValue(val){
  if (val === '4x4'){ state.rows = 4; state.cols = 4; }
  else if (val === '3x3'){ state.rows = 3; state.cols = 3; }
  else if (val === '3x4'){ state.rows = 4; state.cols = 3; }
  else {
    const parts = val.split('x').map(Number);
    if (parts.length===2){ state.cols = parts[0]; state.rows = parts[1]; }
  }
}

/* grid + rendering */
function randomiseGrid(){
  const needed = state.rows * state.cols;
  const factsEn = I18N.en.facts; // index base from English master
  const indices = [...Array(factsEn.length).keys()];
  shuffleArray(indices);
  state.grid = indices.slice(0, needed);
  state.answers = {};
  state.completedLines = new Set();
  state.roundPraiseUsed = []; // reset per round
  renderBoard(); updateProgress(); saveState();
}
function tileTextByIndex(idx){
  const factsLang = getFacts();
  const fallback = I18N.en.facts;
  const factIndex = state.grid[idx];
  const fromLang = factsLang[factIndex];
  return (typeof fromLang === 'string' && fromLang.length) ? fromLang : fallback[factIndex] || '';
}
function tileIconByIndex(idx){ const factIdx = state.grid[idx]; return ICONS[factIdx] || { fa:'fa-circle-question', emoji:'‚ùì' }; }

function renderBoard(){
  const R = state.rows, C = state.cols;
  const totalTiles = R * C;
  if (!Array.isArray(state.grid) || state.grid.length !== totalTiles){ randomiseGrid(); return; }

  boardEl.innerHTML = '';
  boardEl.style.gridTemplateColumns = `repeat(${C}, 1fr)`;
  for (let i=0;i<totalTiles;i++){
    const fact = tileTextByIndex(i);
    const icon = tileIconByIndex(i);
    const entry = state.answers[i];
    const tile = document.createElement('button');
    tile.type = 'button';
    tile.className = 'tile';
    tile.dataset.index = i;
    const emojiHtml = `<span class="emoji-fallback" aria-hidden="true">${icon.emoji}</span>`;
    tile.innerHTML = `
      ${emojiHtml}
      <div class="fact">${safeEscape(fact)}</div>
      <div class="meta"><span class="who">${ entry ? safeEscape(entry.name) : '' }</span></div>
      ${ entry ? `<div class="entry"><div class="resp">${safeEscape(entry.resp)}</div></div>` : '' }
    `;
    if (entry) tile.classList.add('filled');
    tile.addEventListener('click', ()=> onTileClick(i, fact));
    boardEl.appendChild(tile);
  }
}

/* modal */
let currentIdx = null;
function onTileClick(idx, fact){
  if (!state.started) return;
  currentIdx = idx;
  modalFact.textContent = fact;
  nameInput.value = state.answers[idx]?.name || '';
  respInput.value = state.answers[idx]?.resp || '';
  respInput.maxLength = RESPONSE_CHAR_LIMIT;
  charLimitEl.textContent = RESPONSE_CHAR_LIMIT;
  updateCharCount();
  try { entryModal.showModal(); } catch(e){ entryModal.setAttribute('open',''); }
  setTimeout(()=> nameInput.focus(), 50);
}
function updateCharCount(){ const left = RESPONSE_CHAR_LIMIT - (respInput.value ? respInput.value.length : 0); charCountEl.textContent = `${left} left`; }
respInput.addEventListener('input', ()=> {
  if (respInput.value.length > RESPONSE_CHAR_LIMIT) respInput.value = respInput.value.slice(0, RESPONSE_CHAR_LIMIT);
  updateCharCount();
});

function limitWords(str, maxWords){
  const words = str.trim().split(/\s+/).filter(Boolean);
  if (words.length <= maxWords) return { text: words.join(' '), truncated: false };
  return { text: words.slice(0, maxWords).join(' ') + '‚Ä¶', truncated: true };
}

saveBtn.addEventListener('click', (e)=>{
  e.preventDefault();
  const name = nameInput.value.trim();
  const resp = respInput.value.trim();
  if (!name || !resp) return;
  const limited = limitWords(resp, 40);
  const finalResp = limited.text.slice(0, RESPONSE_CHAR_LIMIT);
  state.answers[currentIdx] = { name: name, resp: finalResp };
  try { entryModal.close(); } catch(e){ entryModal.removeAttribute('open'); }
  renderBoard();
  const added = checkForNewBingo(); // returns number of new lines
  if (added > 0){
    showBingoWithPraise(name, added); // show once with (xN)
  }
  updateProgress();
  saveState();
});
cancelBtn.addEventListener('click', (e)=>{ e.preventDefault(); try { entryModal.close(); } catch(e){ entryModal.removeAttribute('open'); } });

/* bingo calculation */
function calculateBingoLines(){
  const R = state.rows, C = state.cols;
  const filled = new Set(Object.keys(state.answers).map(Number));
  const lines = [];
  // rows
  for (let r=0;r<R;r++){ const row=[]; for (let c=0;c<C;c++) row.push(r*C + c); lines.push(row); }
  // cols
  for (let c=0;c<C;c++){ const col=[]; for (let r=0;r<R;r++) col.push(r*C + c); lines.push(col); }
  // diagonals if square
  if (R === C){
    const d1=[]; for (let i=0;i<R;i++) d1.push(i*C+i); lines.push(d1);
    const d2=[]; for (let i=0;i<R;i++) d2.push(i*C+(C-1-i)); lines.push(d2);
  }
  const completed = new Set();
  lines.forEach((l,i)=>{ if (l.every(x=>filled.has(x))) completed.add(i); });
  return completed;
}

function checkForNewBingo(){
  const now = calculateBingoLines();
  const prev = state.completedLines || new Set();
  const newLines = [...now].filter(i => !prev.has(i));
  if (newLines.length > 0){ state.completedLines = now; }
  return newLines.length;
}

/* praise selection ‚Äî no repeats within round; slight weight for animated */
function pickPraiseIndexRound(){
  const praises = getPraises();
  const used = new Set(state.roundPraiseUsed || []);
  const available = praises.map((_,i)=>i).filter(i=>!used.has(i));
  if (available.length === 0){
    // reset cycle
    state.roundPraiseUsed = [];
    saveState();
    return pickPraiseIndexRound();
  }
  const weighted = [];
  available.forEach(i=>{
    const w = praises[i].effect ? 2 : 1; // slight bias for animated
    for (let k=0;k<w;k++) weighted.push(i);
  });
  const choice = weighted[Math.floor(Math.random()*weighted.length)];
  state.roundPraiseUsed.push(choice);
  saveState();
  return choice;
}

/* show bingo + praise + effect (stacked) */
function showBingoWithPraise(personName, linesCount){
  bingoOverlay.classList.add('show');
  bingoOverlay.setAttribute('aria-hidden','false');

  bingoText.textContent = linesCount>1 ? `BINGO! (x${linesCount})` : 'BINGO!';

  const praises = getPraises();
  const idx = pickPraiseIndexRound();
  const phraseObj = praises[idx] || { text:'Nice!' };
  const phrase = phraseObj.text || 'Nice!';
  praiseEl.textContent = phrase;
  praiseEl.classList.remove('hidden');
  setTimeout(()=> praiseEl.classList.add('visible'), 10);

  // prepare effect area
  effectsEl.innerHTML = '';
  if (phraseObj.effect){
    const node = buildEffectNode(phraseObj.effect);
    if (node) effectsEl.appendChild(node);
  }

  // confetti (short)
  const duration = 900; const end = Date.now() + duration;
  (function frame(){
    confetti({ particleCount: 10, spread: 60, startVelocity: 40, origin: { x: Math.random(), y: Math.random()*0.35 }});
    if (Date.now() < end) requestAnimationFrame(frame);
  })();

  state.justShownAt = Date.now();
}

/* build effect DOM (centered under praise) */
function buildEffectNode(key){
  switch(key){
    case 'parade': {
      const c = document.createElement('div'); c.className='parade';
      ['üé∫','üéâ','ü•Å','ü™Ö','üï∫'].forEach(e=>{ const s=document.createElement('span'); s.textContent=e; c.appendChild(s); });
      return c;
    }
    case 'trending': {
      const el = document.createElement('div'); el.className='leaderboard';
      el.innerHTML = `<h4>‚ú® #1 Trending</h4><div style="font-size:13px; opacity:.9;">People are talking about your bingo.</div>`;
      return el;
    }
    case 'barrel': { const b=document.createElement('div'); b.className='barrel'; b.textContent='üõ¢Ô∏è'; return b; }
    case 'pokeball': { const p=document.createElement('div'); p.className='pokeball'; p.textContent='‚ö™Ô∏è'; return p; }
    case 'thumb': { const t=document.createElement('div'); t.className='thumbup'; t.textContent='üëç'; return t; }
    case 'chef': { const c=document.createElement('div'); c.className='chefkiss'; c.textContent='üë®‚Äçüç≥üíã'; return c; }
    case 'divine': {
      const wrap=document.createElement('div'); wrap.className='divine';
      const eyes=document.createElement('div'); eyes.className='glow-eyes'; eyes.textContent='üëÄ';
      wrap.appendChild(eyes); return wrap;
    }
    case 'leader': {
      const el=document.createElement('div'); el.className='leaderboard';
      el.innerHTML=`<h4>üèÜ Bingo Hall of Fame</h4><ul style="margin:0;padding-left:18px;"><li><strong>You</strong> ‚Äî 1,234 pts</li><li>Alex ‚Äî 1,220 pts</li><li>Jordan ‚Äî 1,119 pts</li></ul>`;
      return el;
    }
    case 'slash': {
      const s=document.createElement('div'); s.className='slash';
      const line=document.createElement('div'); line.className='line'; s.appendChild(line);
      return s;
    }
    case 'rename': {
      const box=document.createElement('div');
      box.style.display='flex'; box.style.flexDirection='row'; box.style.gap='10px'; box.style.alignItems='center';
      const clap=document.createElement('div'); clap.className='clapper'; clap.textContent='üé¨';
      const title=document.getElementById('pageTitle');
      if (!title.dataset._orig){ title.dataset._orig = title.textContent; }
      title.textContent = 'Who the Fact are YOU?!';
      box.appendChild(clap);
      return box;
    }
    case 'cinematic': {
      const stack=document.createElement('div');
      stack.style.display='flex'; stack.style.flexDirection='column'; stack.style.alignItems='center'; stack.style.gap='8px';
      const top=document.createElement('div'); top.className='cinematic-bar';
      const bottom=document.createElement('div'); bottom.className='cinematic-bar';
      const clap=document.createElement('div'); clap.className='clapper'; clap.textContent='üé¨';
      stack.appendChild(top); stack.appendChild(clap); stack.appendChild(bottom);
      return stack;
    }
    default: return null;
  }
}

/* dismiss visuals on any screen click (but ignore the same click that caused it) */
function onScreenClick(e){
  if (e.target.closest('.modal')) return;
  const elapsed = Date.now() - (state.justShownAt || 0);
  if (elapsed < 200) return; // guard so it doesn't instantly close on the same click
  if (bingoOverlay.classList.contains('show')){
    // hide everything
    bingoOverlay.classList.remove('show');
    bingoOverlay.setAttribute('aria-hidden','true');
    praiseEl.classList.remove('visible');
    setTimeout(()=> praiseEl.classList.add('hidden'), 180);
    effectsEl.innerHTML = '';
    // restore title if renamed
    const title=document.getElementById('pageTitle');
    if (title && title.dataset._orig){ title.textContent = title.dataset._orig; delete title.dataset._orig; }
  }
}
document.addEventListener('click', onScreenClick);
bingoOverlay.addEventListener('click', (e)=>{ e.stopPropagation(); onScreenClick(e); });
document.getElementById('praise').addEventListener('click', (e)=>{ e.stopPropagation(); onScreenClick(e); });

/* progress text */
function updateProgress(){
  const filled = Object.keys(state.answers).length;
  const total = state.rows * state.cols;
  const lines = calculateBingoLines();
  const ui = getUI();
  progressEl.textContent = `${ui.filled(filled, total)} ¬∑ ${ui.lines(lines.size)}`;
}

/* controls */
randomBtn.addEventListener('click', ()=>{
  if (state.started) return;
  if (state.randomLeft <= 0) return;
  state.randomLeft--; rndLeftEl.textContent = state.randomLeft;
  randomiseGrid();
});

startBtn.addEventListener('click', ()=>{
  if (!state.started){
    state.started = true; saveState();
    preHint.style.display = 'none';
    startBtn.classList.remove('primary');
    startBtn.innerHTML = `‚Ü∫ ${getUI().reset || 'Reset'}`;
    randomBtn.disabled = true;
    state.roundPraiseUsed = []; // new round
  } else {
    // reset the round
    state.started = false; state.answers = {}; state.completedLines = new Set();
    state.randomLeft = 3; rndLeftEl.textContent = '3';
    startBtn.classList.add('primary'); startBtn.innerHTML = `‚ñ∂ ${getUI().start || 'Start Bingo'}`;
    randomBtn.disabled = false;
    state.roundPraiseUsed = [];
    renderBoard(); updateProgress(); saveState();
  }
});

/* dark toggle */
function updateDarkToggleLabel(){
  const ui = getUI();
  if (document.body.classList.contains('dark')) darkToggle.textContent = ui.lightMode || '‚òÄ Light mode';
  else darkToggle.textContent = ui.darkMode || 'üåô Dark mode';
}
darkToggle.addEventListener('click', ()=>{
  document.body.classList.toggle('dark');
  darkToggle.setAttribute('aria-pressed', document.body.classList.contains('dark') ? 'true' : 'false');
  localStorage.setItem('wtaf-dark', document.body.classList.contains('dark') ? '1' : '0');
  updateDarkToggleLabel();
});

/* language ‚Äî IMPORTANT: do NOT reshuffle or clear answers; just re-render with translated text */
langSel.addEventListener('change', ()=>{
  state.lang = langSel.value;
  localStorage.setItem('wtaf-lang', state.lang);
  applyLang();        // updates UI strings
  renderBoard();      // re-render tiles with same indices, translated text
  updateProgress();
  saveState();
});

/* layout selector (this resets round) */
layoutSel.addEventListener('change', ()=>{
  setLayoutByValue(layoutSel.value);
  state.started = false;
  state.answers = {};
  state.completedLines = new Set();
  state.randomLeft = 3; rndLeftEl.textContent = String(state.randomLeft);
  state.roundPraiseUsed = [];
  randomiseGrid();
  applyLang();
  updateProgress();
});

/* font size */
const FONT_MIN = 12, FONT_MAX = 22;
function getSavedFontSize(){ const v = parseInt(localStorage.getItem('wtaf-fontsize') || '', 10); return Number.isFinite(v) ? v : 16; }
function setFontSize(px){ const clamped = Math.max(FONT_MIN, Math.min(FONT_MAX, Math.round(px))); document.documentElement.style.setProperty('--ui-font-size', clamped + 'px'); localStorage.setItem('wtaf-fontsize', String(clamped)); }
document.getElementById('fontInc').addEventListener('click', ()=>{ const cur = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--ui-font-size')||'16',10); setFontSize(cur+1); renderBoard(); });
document.getElementById('fontDec').addEventListener('click', ()=>{ const cur = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--ui-font-size')||'16',10); setFontSize(cur-1); renderBoard(); });

/* boot */
loadState();
document.body.classList.toggle('dark', localStorage.getItem('wtaf-dark') === '1');
rndLeftEl.textContent = state.randomLeft;
setFontSize(getSavedFontSize());
applyLang();
if (!Array.isArray(state.grid) || state.grid.length !== state.rows * state.cols) {
  randomiseGrid();
}
if (state.started){ startBtn.classList.remove('primary'); startBtn.innerHTML = `‚Ü∫ ${getUI().reset || 'Reset'}`; randomBtn.disabled = true; }

/* apply language UI strings (no randomise/clear here) */
function applyLang(){
  const ui = getUI();
  document.querySelector('[data-i18n="randomize"]').textContent = ui.randomize || 'Randomise board';
  const startSpan = startBtn.querySelector('[data-i18n]');
  if (startSpan) startSpan.textContent = ui.start || 'Start Bingo';
  preHint.textContent = ui.preHint || '';
  howto.textContent = ui.howto || '';
  modalTitle.textContent = ui.modalTitle || '';
  document.getElementById('nameLabel').textContent = ui.nameLabel || 'Name';
  document.getElementById('respLabel').textContent = ui.respLabel || 'Response';
  charLimitEl.textContent = RESPONSE_CHAR_LIMIT;
  document.getElementById('respHint').textContent = (ui.respHint || 'Max {n} chars').replace('{n}', RESPONSE_CHAR_LIMIT);
  cancelBtn.textContent = ui.cancel || 'Cancel';
  saveBtn.textContent = ui.save || 'Save';
  updateDarkToggleLabel();
  layoutSel.value = layoutValueFromRowsCols(state.rows, state.cols);
}

/* small self-test */
(function runSelfTests(){ try{ const tmp = { completedLines: new Set([1,2,7]) }; const s = JSON.stringify({completedLines:Array.from(tmp.completedLines)}); const r = JSON.parse(s); console.assert(Array.isArray(r.completedLines),'selftest'); }catch(e){} })();

</script>
</body>
</html>
